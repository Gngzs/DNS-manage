<!DOCTYPE html>
<html lang="zh">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta name="keywords" content="LightYear,LightYearAdmin,光年,后台模板,后台管理系统,光年HTML模板">
    <meta name="description" content="Light Year Admin V5是一个基于Bootstrap v5.1.3的后台管理系统的HTML模板。">
    <meta name="author" content="yinq">
    <title>服务商列表</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="stylesheet" type="text/css" href="css/materialdesignicons.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.min.css">
    <link rel="stylesheet" type="text/css" href="js/bootstrap-table/bootstrap-table.min.css">
</head>

<body>
    <!--页面loading-->
    <div id="lyear-preloader" class="loading">
        <div class="ctn-preloader">
            <div class="round_spinner">
                <div class="spinner"></div>
                <img src="images/loading-logo.png" alt="">
            </div>
        </div>
    </div>
    <!--页面loading end-->
    <div class="lyear-layout-web">
        <div class="lyear-layout-container">
            <!--左侧导航-->
            <div class="menupage"></div>
            <!--End 左侧导航-->
            <!--头部信息-->
            <div class="headerpage"></div>
            <!--End 头部信息-->
            <!--页面主要内容-->
            <main class="lyear-layout-content">
                <div class="container-fluid">

                    <div class="row">

                        <div class="col-lg-12">
                            <div class="card">
                                <header class="card-header">
                                    <div class="card-title">服务商列表</div>
                                </header>
                                <div class="card-body">

                                    <table id="domain-list"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <!--End 页面主要内容-->
        </div>
    </div>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/popper.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/perfect-scrollbar.min.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="js/main.min.js"></script>
    <!--引入table插件-->
    <script src="js/bootstrap-table/bootstrap-table.js"></script>
    <script src="js/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script type="text/javascript">
        $(function () {
            if ($.cookie("Authorization") != null) {
                $.ajax({
                    url: 'api/ajax.php',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        action: 'checklogin',
                    },
                    success: function (response) {
                        if (response['status'] == 'error') {
                            location.href = 'login.html';
                        };
                    }
                });
            } else {
                location.href = "login.html";
            };
            $(".headerpage").load('header.html');
            $(".menupage").load('menu.html');
        });
        var columns = [{
            field: "servername",
            title: "名称",
            width: "150"
        }, {
            field: "server",
            title: "服务商",
            width: "150"
        }, {
            field: "secretid",
            title: "访问密钥ID"
        }, {
            field: "secretkey",
            title: "访问密钥Key"
        }, {
            field: "status",
            title: "状态",
            width: "150",
            formatter: function (value,row,index){
                return '<a class="btn btn-sm btn-default me-1 check-btn" id="check'+index+'" data-bs-toggle="tooltip">测试连接</a>';
            },
            events: {
                'click .check-btn': function (event, value, row, index) {
                    event.stopPropagation();
                    checkfunc(row,index);
                }
            }
        }, {
            field: "enable",
            title: "启用/禁用",
            width: "150",
            formatter: function (value, row, index) {
                if (value == 0) {
                    return '<span class="badge bg-danger">禁用</span>';
                } else if (value == 1) {
                    return '<span class="badge bg-success">启用</span>';
                } else {
                    return '<span class="badge bg-secondary">未知</span>';
                }
            }
        }, {
            field: "operate",
            title: "操作",
            width: "250"
        }];

        function checkfunc(test,number) {
            document.getElementById('check'+number).innerHTML = '<div class="spinner-border text-primary spinner-border-sm" role="status"><span class="visually-hidden">加载中...</span></div>加载中';
            $.ajax({
                url: 'api/ajax.php',
                type: 'POST',
                dataType: 'json',
                data: {
                    action: 'checkServerStatus',
                    server: test.server,
                    secretid: test.secretid,
                    secretkey: test.secretkey,
                },
                success: function (response) {
                    if (response['status'] == 'server_error') {
                        document.getElementById('check'+number).textContent = '连接失败';
                    } else {
                        document.getElementById('check'+number).textContent = '连接成功';
                    };
                }
            });

        };

        $('#domain-list').bootstrapTable({
            columns: columns,
            url: "/api/ajax.php",
            dataType: "json",
            method: "POST",
            sidePagination: 'server',
            pagination: true,
            pageNumber: 1,
            pageSize: 10,
            contentType: "application/x-www-form-urlencoded",
            pageList: "[10, 20, 50, 200]",
            paginationHAlign: "left",
            paginationDetailHAlign: "right",
            queryParams: function (params) {
                params.action = "getServerList";
                return params;
            },
            onLoadSuccess: function (data) {
                $("[data-bs-toggle='tooltip']").tooltip();
            }
        });


    </script>
</body>

</html>